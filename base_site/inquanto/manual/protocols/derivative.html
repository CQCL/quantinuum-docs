<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YPQ1FTGDL3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YPQ1FTGDL3');
    </script>
    <link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Other averaging protocols" href="other.html" /><link rel="prev" title="Protocols for overlaps" href="overlap.html" />

    <link rel="shortcut icon" href="../../_static/quantinuum_favicon.svg"/><!-- Generated with Sphinx 6.2.1 and Furo 2024.08.06 -->
        <title>Protocols for derivatives - InQuanto 4.2.0</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=04c057b233f3c8d71940eee6080f658a04e2027d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=cf727022eb7470bc603c08d2e55c3247faec75c9" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style>
<link rel="stylesheet" href="../../_static/tokens.css"/>
<link rel="stylesheet" href="../../_static/styles.css"/>
<link rel="stylesheet" href="../../_static/tailwind.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="preload"
as="style">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

<style>  
  .sidebar-sticky {
    top: calc(3.5rem - 0px);
    height: calc(100vh - 3.5rem);
  }
  
  @media (min-width: 97em) {
    html {
      font-size: 100% !important;
    }
  }
  
</style>
</head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>
<!-- <script type="text/javascript" src="../../_static/syncTheme.global.js" ></script> -->
 <!--Force light mode -->
 <script>document.body.setAttribute('data-theme','light')</script>
<nav style="position:fixed;top:0;z-index:1021;width:100%;">
    <div class="nexus-nav"></div>
</nav>
<script type="text/javascript" src="../../_static/injectNav.global.js"></script>
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">InQuanto 4.2.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/inquanto_short_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">InQuanto 4.2.0</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/overview.html">What is InQuanto?</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../introduction/installation.html">Installation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/system_requirements.html">System Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/troubleshooting.html">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/quickstart.html">Quick-start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../howto.html">How to use InQuanto</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../algorithms_overview.html">Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Algorithms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../algorithms/variational_overview.html">Variational Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Variational Algorithms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/algorithms_vqe.html">Variational Quantum Eigensolver <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmVQE</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/algorithms_vqd.html">Variational Quantum Deflation <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmVQD</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/algorithms_adapt.html">ADAPT-VQE</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../algorithms/non_variational_overview.html">Non-variational and Phase Estimation algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Non-variational and Phase Estimation algorithms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/algorithms_qse.html">Quantum Subspace Expansion <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmQSE</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/algorithms_sceom.html">Quantum Self Consistent Equation of Motion <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmSCEOM</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/qpe_canonical.html">Canonical Quantum Phase Estimation <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmDeterministicQPE</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/qpe_iterative.html">Iterative Phase Estimation Algorithms</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../algorithms/time_evolution_overview.html">Time evolution algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Time evolution algorithms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../algorithms/te_vqs.html"><code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmVQS</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmMcLachlanRealTime</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmMcLachlanImagTime</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../computables_overview.html">Computables</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Computables</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../computables/basic_usage.html">Basic Usage and Composability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computables/evaluating_w_protocols.html">Evaluating Computables with Protocols</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../computables/composite_computables.html">Composite Computables</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Composite Computables</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../computables/greens_function.html">Krylov subspace &amp; Green’s functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computables/rdms.html">Reduced Density Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computables/overlap_matrix.html">Overlap Matrices &amp; Non-Orthogonal Subspaces</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../computables/primitives.html">Primitive Computables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computables/custom_computables.html">Custom Computables &amp; Partial Evaluations</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../protocols_overview.html">Protocols</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Protocols</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="expval.html">Protocols for expectation values</a></li>
<li class="toctree-l2"><a class="reference internal" href="overlap_squared.html">Protocols for overlap squared</a></li>
<li class="toctree-l2"><a class="reference internal" href="overlap.html">Protocols for overlaps</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Protocols for derivatives</a></li>
<li class="toctree-l2"><a class="reference internal" href="other.html">Other averaging protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="phase_est.html">Protocols for Phase Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="resource_estimation.html">Resource estimation</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../errmit.html">Noise mitigation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spaces.html">Spaces, Operators, and States</a></li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ansatzae_overview.html">Ansatzes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Ansatzes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/ucc_family.html">The UCC Family</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/chemically_aware.html">Chemically Aware Ansatz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/trotter_ansatz.html">Trotter Ansatz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/fermion_state_exp.html">Fermionic Exponentiated Ansatz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/circuit_ansatz.html">Circuit Ansatz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/composed_ansatz.html">Composed Ansatz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/hea.html">Hardware Efficient Ansatz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/multi_configurational.html">Multiconfiguration States Using Givens Rotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansatze/basis_rotation.html">Real Basis Rotation Ansatzes</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../symmetry.html">Symmetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometry.html">Geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../minimizers.html">Classical Minimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dmet.html">Density Matrix Embedding Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../express.html">Express</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials &amp; Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial_overview.html">Tutorials</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/tutorial_overview.html#core-tutorials">Core Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Core Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_vqe_1.html">A basic VQE simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_vqe_2.html">Extended VQE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_vqd.html">Variational Quantum Deflation for excited states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_viz.html">Visualization with inquanto-nglview</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/tutorial_overview.html#backend-tutorials">Backend Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Backend Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/backends_overview.html">Backends Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_Nexus_1.html"><b>Tutorial: InQuanto + qnexus</b></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_htut_Aer_H2.html">Running on the Aer simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_htut_qsys_H2.html">Running on Quantinuum Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_htut_qsys_l%2Br.html">Quantinuum Systems -  Launching circuits and retrieving results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_htut_qsys_qse.html">Quantinuum Systems -  Quantum Subspace Expansion</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/tutorial_overview.html#case-study-tutorials-fe4n2">Case Study Tutorials - Fe4N2</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Case Study Tutorials - Fe4N2</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_fe4n2_1.html">Fe4N2 - 1 - system construction with AVAS and CASSCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_fe4n2_2.html">Fe4N2 - 2 - circuit construction with ADAPT-VQE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_fe4n2_3.html">Fe4N2 - 3 - calculations on Quantinuum hardware</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/tutorial_overview.html#fragmentation-tutorials">Fragmentation Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Fragmentation Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_dmet.html">Tackling larger systems with fragmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_wft_dft.html">Projection-based embedding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_nevpt2_AC0.html">NEVPT2 and AC0 energy corrections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/InQ_tut_wft_dft_2.html">Projection-based embedding with energy corrections</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/examples_overview.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extensions User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../extensions/extensions-overview.html">Extensions overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions/inquanto-nexus.html">InQuanto-Nexus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions/inquanto-pyscf.html">InQuanto-PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions/inquanto-nglview.html">InQuanto-NGLView</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions/inquanto-phayes.html">InQuanto-Phayes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../extensions/extensions_examples.html">Extensions examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/inquanto_api_intro.html">InQuanto</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of InQuanto</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/algorithms.html">inquanto.algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/ansatz.html">inquanto.ansatzes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/computables.html">inquanto.computables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/core.html">inquanto.core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/embeddings.html">inquanto.embeddings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/express.html">inquanto.express</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/geometry.html">inquanto.geometries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/mappings.html">inquanto.mappings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/minimizers.html">inquanto.minimizers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/operators.html">inquanto.operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/protocols.html">inquanto.protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/spaces.html">inquanto.spaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/states.html">inquanto.states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/inquanto/symmetry.html">inquanto.symmetry</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/inquanto-ext_api_intro.html">InQuanto-Extensions</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of InQuanto-Extensions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/extensions/inquanto-nexus_api.html">InQuanto-Nexus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/extensions/inquanto-pyscf_api.html">InQuanto-PySCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/extensions/inquanto-nglview_api.html">InQuanto-NGLView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/extensions/inquanto-phayes.html">InQuanto-Phayes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/extensions/inquanto-cutensornet_api.html">InQuanto-cuTensorNet</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/changelog.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/contact.html">Contact Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/cite.html">How to cite InQuanto</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/licence.html">License and Notices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/opensource.html">Open-source Attribution</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="protocols-for-derivatives">
<h1>Protocols for derivatives<a class="headerlink" href="#protocols-for-derivatives" title="Permalink to this heading">¶</a></h1>
<p>Shot-based calculations of derivatives with respect to ansatz parameters are supported by three InQuanto protocols: <a class="reference internal" href="../../api/inquanto/protocols.html#inquanto.protocols.HadamardTestDerivative" title="inquanto.protocols.HadamardTestDerivative"><code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivative</span></code></a>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">PhaseShift</span></code>, and <a class="reference internal" href="../../api/inquanto/protocols.html#inquanto.protocols.HadamardTestDerivativeOverlap" title="inquanto.protocols.HadamardTestDerivativeOverlap"><code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivativeOverlap</span></code></a>, each of which has different capabilities. Given a parameterized
state <span class="math notranslate nohighlight">\(\ket{\psi(\boldsymbol\theta)}\)</span>, in general one may be interested in a range of different derivative <a class="reference external" href="../computables_overview.html">computables</a>.
Those supported by one or more of the protocols in this section are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../api/inquanto/computables.html#inquanto.computables.atomic.ExpectationValueDerivative" title="inquanto.computables.atomic.ExpectationValueDerivative"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExpectationValueDerivative</span></code></a>, with a Hermitian kernel <span class="math notranslate nohighlight">\(H = \sum_i h_i P_i\)</span> written as a linear combination of Pauli strings:</p></li>
</ul>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-0">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-0">
<span class="eqno">(49)<a class="headerlink" href="#equation-manual-protocols-derivative-0" title="Permalink to this equation">¶</a></span>\[\frac{\partial }{\partial \theta_i} \langle \psi(\boldsymbol\theta) | H | \psi(\boldsymbol\theta) \rangle\]</div>
</div>
<ul class="simple">
<li><p>Bra or ket derivatives (see <a class="reference internal" href="../../api/inquanto/computables.html#inquanto.computables.atomic.ExpectationValueBraDerivativeReal" title="inquanto.computables.atomic.ExpectationValueBraDerivativeReal"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExpectationValueBraDerivativeReal</span></code></a> and related classes):</p></li>
</ul>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-1">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-1">
<span class="eqno">(50)<a class="headerlink" href="#equation-manual-protocols-derivative-1" title="Permalink to this equation">¶</a></span>\[\Braket{
   \frac{\partial \psi}{\partial \theta_i} | H | \psi(\boldsymbol\theta)
}\]</div>
</div>
<ul class="simple">
<li><p>Derivative overlaps, also referred to as the metric tensor (see <a class="reference internal" href="../../api/inquanto/computables.html#inquanto.computables.atomic.MetricTensorReal" title="inquanto.computables.atomic.MetricTensorReal"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetricTensorReal</span></code></a>):</p></li>
</ul>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-2">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-2">
<span class="eqno">(51)<a class="headerlink" href="#equation-manual-protocols-derivative-2" title="Permalink to this equation">¶</a></span>\[\Braket{
     \frac{\partial \psi}{\partial \theta_i} |
     \frac{\partial \psi}{\partial \theta_j}
 }\]</div>
</div>
<p>In general, a parameterized ansatz in InQuanto may be written as:</p>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-3">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-3">
<span class="eqno">(52)<a class="headerlink" href="#equation-manual-protocols-derivative-3" title="Permalink to this equation">¶</a></span>\[\ket{\psi(\theta_0, \theta_1, \dots)} = U(\theta_0, \theta_1, \dots)\ket{\bar{0}} =  \prod_i U_i(\theta_0, \theta_1, \dots)\ket{\bar{0}}\]</div>
</div>
<p>where each gate in the state preparation unitary may depend on any number of parameters. In all the methods discussed below, the ansatz is “regularized” such that each gate in the state
preparation unitary contains only one parameter, each parameter appears only once, and all parameterized gates are single-qubit rotation gates. This regularization procedure is done by the protocols internally. In what follows we do so by rewriting the ansatz in terms of
the dummy parameters <span class="math notranslate nohighlight">\(\gamma_i\)</span> (non-parameterized gates are implicitly included):</p>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-4">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-4">
<span class="eqno">(53)<a class="headerlink" href="#equation-manual-protocols-derivative-4" title="Permalink to this equation">¶</a></span>\[\ket{\psi(\gamma_0, \gamma_1, \dots)} =  \prod_i U_i(\gamma_i)\ket{\bar{0}}\]</div>
</div>
<p>where the parameterized gates now take the form <span class="math notranslate nohighlight">\(U_j(\gamma_j) = \exp(-i\gamma_j P_j)\)</span>. The derivatives of interest are written using the chain rule:</p>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-5">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-5">
<span class="eqno">(54)<a class="headerlink" href="#equation-manual-protocols-derivative-5" title="Permalink to this equation">¶</a></span>\[\Ket{\frac{\partial \psi}{\partial \theta_j}} = \sum_i J_{ij} \Ket{\frac{\partial \psi}{\partial \gamma_i}}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(J_{ij}=\partial \gamma_i/\partial \theta_j\)</span> is the Jacobian matrix for this transformation. Derivatives with respect to regularized parameters <span class="math notranslate nohighlight">\(\gamma_i\)</span> are simpler
to compute, and are the quantities computed at the circuit level in all of the protocols below.</p>
<section id="hadamardtestderivative">
<h2>HadamardTestDerivative<a class="headerlink" href="#hadamardtestderivative" title="Permalink to this heading">¶</a></h2>
<p>The partial (bra) derivative of an expectation value can be written as:</p>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-6">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-6">
<span class="eqno">(55)<a class="headerlink" href="#equation-manual-protocols-derivative-6" title="Permalink to this equation">¶</a></span>\[\Braket{
   \frac{\partial \psi}{\partial \gamma_k} | \hat{O} | \psi(\boldsymbol\gamma)
} = -i \Braket{
   \bar{0} | \hat{W}^{k-1 \dagger}_0 \hat{G}_k \hat{W}^{n \dagger}_k \hat{O} | \psi(\boldsymbol\gamma)
}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\hat{W}^n_k = U_n(\gamma_n)\dots U_{k+1}(\gamma_{k+1}) U_k(\gamma_k)\)</span> and
<span class="math notranslate nohighlight">\(\frac{\partial U}{\partial \gamma_k} = -i\hat{G}_k e^{-i\gamma_k \hat{G}_k}\)</span> is
the gate (unitary) derivative <span id="id1">[<a class="reference internal" href="../../misc/bibliography.html#id39" title="Gian Giacomo Guerreschi and Mikhail Smelyanskiy. Practical optimization for hybrid quantum-classical algorithms. 2017. arXiv:1701.01450.">33</a>]</span>.</p>
<p>The <a class="reference internal" href="../../api/inquanto/protocols.html#inquanto.protocols.HadamardTestDerivative" title="inquanto.protocols.HadamardTestDerivative"><code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivative</span></code></a> protocol directly implements the
above formula. The <span class="math notranslate nohighlight">\(\hat{G}_k\)</span> gate, which is a Pauli word in a regularized circuit,
is placed in the middle of a parameterized circuit, controlled and measured on an ancilla qubit.
A specific Pauli (Y or Z) gate being applied to the ancilla register determines whether
one obtains real or imaginary part of the derivative. The Pauli strings constituting the
observable can be either measured directly on the system register qubits as in
<a class="reference internal" href="expval.html#pauliaveraging"><span class="std std-ref">PauliAveraging</span></a> or also on the ancilla register as in <a class="reference internal" href="expval.html#hadamardtest"><span class="std std-ref">HadamardTest</span></a>.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.express</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_h5</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">QubitOperatorList</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.states</span><span class="w"> </span><span class="kn">import</span> <span class="n">QubitState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.ansatzes</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrotterAnsatz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.computables</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectationValueBraDerivativeReal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.protocols</span><span class="w"> </span><span class="kn">import</span> <span class="n">HadamardTestDerivative</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytket.extensions.qiskit</span><span class="w"> </span><span class="kn">import</span> <span class="n">AerBackend</span>

<span class="n">h2</span> <span class="o">=</span> <span class="n">load_h5</span><span class="p">(</span><span class="s2">&quot;h2_sto3g.h5&quot;</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">h2</span><span class="o">.</span><span class="n">hamiltonian_operator</span><span class="o">.</span><span class="n">qubit_encode</span><span class="p">()</span>

<span class="n">exponents</span> <span class="o">=</span> <span class="n">QubitOperatorList</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;theta0 + 0.2*theta1 [(1j, Y0 X1 X2 X3)]&quot;</span><span class="p">)</span>
<span class="n">reference</span> <span class="o">=</span> <span class="n">QubitState</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ansatz</span> <span class="o">=</span> <span class="n">TrotterAnsatz</span><span class="p">(</span><span class="n">exponents</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="n">ansatz</span><span class="o">.</span><span class="n">state_symbols</span><span class="o">.</span><span class="n">construct_from_array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.111</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0555</span><span class="p">])</span>

<span class="n">gradient_expression</span> <span class="o">=</span> <span class="n">ExpectationValueBraDerivativeReal</span><span class="p">(</span>
    <span class="n">ansatz</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">ansatz</span><span class="o">.</span><span class="n">free_symbols_ordered</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">protocol</span> <span class="o">=</span> <span class="n">HadamardTestDerivative</span><span class="p">(</span>
    <span class="n">AerBackend</span><span class="p">(),</span> <span class="n">shots_per_circuit</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">build_from</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradient_expression</span><span class="p">)</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">compile_circuits</span><span class="p">()</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">gradient_expression</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">get_evaluator</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>{theta0: -0.026828562343515758, theta1: -0.005365712468703153}
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="id3">
<img alt="../../_images/hadamard_direct.png" src="../../_images/hadamard_direct.png" />
<figcaption>
<p><span class="caption-number">Fig. 18 </span><span class="caption-text">Measurement circuit generated by <code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDeriative</span></code> with <code class="code docutils literal notranslate"><span class="pre">direct=True</span></code>,
where <span class="math notranslate nohighlight">\(X_{ijk\dots}\)</span> is the set of gates required to measure a commuting set of
Pauli terms in the Hamiltonian.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id4">
<img alt="../../_images/hadamard_indirect.png" src="../../_images/hadamard_indirect.png" />
<figcaption>
<p><span class="caption-number">Fig. 19 </span><span class="caption-text">Measurement circuit generated by <code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivative</span></code> with <code class="code docutils literal notranslate"><span class="pre">direct=False</span></code>,
where <span class="math notranslate nohighlight">\(X_{ijk\dots}\)</span> is the set of gates required to measure a commuting set of
Pauli terms in the Hamiltonian.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="hadamardtestderivativeoverlap">
<h2>HadamardTestDerivativeOverlap<a class="headerlink" href="#hadamardtestderivativeoverlap" title="Permalink to this heading">¶</a></h2>
<p>The <a class="reference internal" href="../../api/inquanto/protocols.html#inquanto.protocols.HadamardTestDerivativeOverlap" title="inquanto.protocols.HadamardTestDerivativeOverlap"><code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivativeOverlap</span></code></a> is a shot-based protocol for computing elements of the metric tensor, based on refs
<span id="id2">[<a class="reference internal" href="../../misc/bibliography.html#id37" title="Maria Schuld, Ville Bergholm, Christian Gogolin, Josh Izaac, and Nathan Killoran. Evaluating analytic gradients on quantum hardware. Physical Review A, 99(3):032331, 2019. doi:https://doi.org/10.1103/PhysRevA.99.032331.">30</a>, <a class="reference internal" href="../../misc/bibliography.html#id84" title="Ying Li and Simon C. Benjamin. Efficient variational quantum simulator incorporating active error minimization. Phys. Rev. X, 7:021050, Jun 2017. doi:10.1103/PhysRevX.7.021050.">34</a>]</span>. In terms of the regularized parameters, this is given by:</p>
<div class="math-wrapper docutils container" id="equation-chainmt">
<div class="math notranslate nohighlight" id="equation-chainmt">
<span class="eqno">(56)<a class="headerlink" href="#equation-chainmt" title="Permalink to this equation">¶</a></span>\[\Braket{
     \frac{\partial \psi}{\partial \theta_i} |
     \frac{\partial \psi}{\partial \theta_j}
 } =
 \sum_{kl} J_{ki} J_{lj} \Braket{
     \frac{\partial \psi}{\partial \gamma_k} |
     \frac{\partial \psi}{\partial \gamma_l}
 }\]</div>
</div>
<p>The regularized derivative overlap is written as:</p>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-7">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-7">
<span class="eqno">(57)<a class="headerlink" href="#equation-manual-protocols-derivative-7" title="Permalink to this equation">¶</a></span>\[\Braket{
     \frac{\partial \psi}{\partial \gamma_k} |
     \frac{\partial \psi}{\partial \gamma_l}
 } =
\Braket{\bar{0} | V_k(\gamma)^\dagger  V_l(\gamma) | \bar{0} }\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(V_i(\boldsymbol\gamma)\)</span> is the i-th derivative of the regularized state preparation unitary:</p>
<div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-8">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-8">
<span class="eqno">(58)<a class="headerlink" href="#equation-manual-protocols-derivative-8" title="Permalink to this equation">¶</a></span>\[V_i(\boldsymbol\gamma) = U_n(\gamma_n)U_{n-1}(\gamma_{n-1})\dots U_i(\gamma_i) P_i \dots U_1(\gamma_1)U_0(\gamma_0)\]</div>
</div>
<p>This overlap may be evaluated with a modified Hadamard test. The Pauli strings injected by the derivatives are carefully applied to the state register, controlled on an ancilla qubit in
a superposition state. For a calculation of the real part of the metric tensor (with <span class="math notranslate nohighlight">\(k&lt;l\)</span>), this circuit is given by:</p>
<figure class="align-center" id="id5">
<a class="reference internal image-reference" href="../../_images/metric_tensor.png"><img alt="../../_images/metric_tensor.png" src="../../_images/metric_tensor.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 20 </span><span class="caption-text">Measurement circuit for the real part of the regularized derivative overlap: <span class="math notranslate nohighlight">\(\text{Re}\Braket{\partial \psi / \partial \gamma_k | \partial \psi / \partial \gamma_l }\)</span> generated by <code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivativeOverlap</span></code>.</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>As with a standard Hadamard test, the regularized derivative overlap is then given by</p>
<blockquote>
<div><div class="math-wrapper docutils container" id="equation-manual-protocols-derivative-9">
<div class="math notranslate nohighlight" id="equation-manual-protocols-derivative-9">
<span class="eqno">(59)<a class="headerlink" href="#equation-manual-protocols-derivative-9" title="Permalink to this equation">¶</a></span>\[\text{Re}\Braket{
     \frac{\partial \psi}{\partial \gamma_k} |
     \frac{\partial \psi}{\partial \gamma_l}
 } = p(0) - p(1)\]</div>
</div>
</div></blockquote>
<p>where <span class="math notranslate nohighlight">\(p(b)\)</span> is the probability of measuring the ancilla qubit in state <span class="math notranslate nohighlight">\(b\in{0, 1}\)</span>. Equation <a class="reference internal" href="#equation-chainmt">(56)</a> then provides the derivatives in terms of the original ansatz parameters.
See a simple example below for a UCCSD ansatz:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.express</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_system</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.ansatzes</span><span class="w"> </span><span class="kn">import</span> <span class="n">FermionSpaceAnsatzUCCSD</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inquanto.protocols</span><span class="w"> </span><span class="kn">import</span> <span class="n">HadamardTestDerivativeOverlap</span>

<span class="n">_</span><span class="p">,</span> <span class="n">fermion_space</span><span class="p">,</span> <span class="n">hf_state</span> <span class="o">=</span> <span class="n">get_system</span><span class="p">(</span><span class="s2">&quot;h2_sto3g.h5&quot;</span><span class="p">)</span>
<span class="n">ansatz</span> <span class="o">=</span> <span class="n">FermionSpaceAnsatzUCCSD</span><span class="p">(</span>
   <span class="n">fermion_space</span><span class="p">,</span> <span class="n">hf_state</span>
<span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">ansatz</span><span class="o">.</span><span class="n">state_symbols</span><span class="o">.</span><span class="n">construct_random</span><span class="p">()</span>
<span class="n">symbols</span> <span class="o">=</span> <span class="n">ansatz</span><span class="o">.</span><span class="n">state_symbols</span><span class="o">.</span><span class="n">symbols</span>
<span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="n">protocol</span> <span class="o">=</span> <span class="n">HadamardTestDerivativeOverlap</span><span class="p">(</span><span class="n">AerBackend</span><span class="p">(),</span> <span class="n">shots_per_circuit</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
   <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
   <span class="n">state</span><span class="o">=</span><span class="n">ansatz</span><span class="p">,</span>
   <span class="n">diff_symbols</span><span class="o">=</span><span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">symbols</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">compile_circuits</span><span class="p">()</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">protocol</span><span class="o">.</span><span class="n">evaluate_derivative_overlap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>{d0: 0.9417154046806644, s0: -1.3965781047011498, s1: -0.6797144480784211}
</pre></div>
</div>
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>{(s0, s0): 1.00000000000000}
</pre></div>
</div>
</div>
</div>
<p>We specify above that the <a class="reference internal" href="../../api/inquanto/protocols.html#inquanto.protocols.HadamardTestDerivativeOverlap" title="inquanto.protocols.HadamardTestDerivativeOverlap"><code class="xref py py-class docutils literal notranslate"><span class="pre">HadamardTestDerivativeOverlap</span></code></a> protocol should build circuits to calculate the <code class="code docutils literal notranslate"><span class="pre">(s0,</span> <span class="pre">s0)</span></code> element of the metric tensor.
The <a class="reference internal" href="../../api/inquanto/protocols.html#inquanto.protocols.HadamardTestDerivativeOverlap.get_dataframe_derivative_overlap" title="inquanto.protocols.HadamardTestDerivativeOverlap.get_dataframe_derivative_overlap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_dataframe_derivative_overlap()</span></code></a> method provides a breakdown of the circuits required for this calculation:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">get_dataframe_derivative_overlap</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>    Symbols Regularized symbols           Prefactor  Circuit index
0  (s0, s0)            (u7, u7)   0.250000000000000            NaN
1  (s0, s0)           (u7, u16)  -0.250000000000000            0.0
2  (s0, s0)           (u16, u7)  -0.250000000000000            0.0
3  (s0, s0)          (u16, u16)   0.250000000000000            NaN
</pre></div>
</div>
</div>
</div>
<p>which shows that only one circuit was required for this calculation. It also reveals that the ansatz regularization replaced two occurances of the symbol <code class="code docutils literal notranslate"><span class="pre">s0</span></code> with the parameters
<code class="code docutils literal notranslate"><span class="pre">u14</span></code> and <code class="code docutils literal notranslate"><span class="pre">u17</span></code> in the 14th and 17th gates of the state preparation unitary respectively. The prefactor column shows the Jacobian product <span class="math notranslate nohighlight">\(J_{ki}J_{lj}\)</span>. This protocol
attempts to minimize the total number of circuits required by exploiting the fact that <span class="math notranslate nohighlight">\(\text{Re}\Braket{\partial_k \psi| \partial_l \psi} = \text{Re}\Braket{\partial_l \psi| \partial_k \psi}\)</span>,
and that diagonal elements are unity. Rows with a <code class="code docutils literal notranslate"><span class="pre">NaN</span></code> circuit index mark these diagonal terms.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="other.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Other averaging protocols</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="overlap.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Protocols for overlaps</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
              Copyright &#169; 2024 Quantinuum Ltd. All rights reserved.
            </div>
            <div class="terms" style="display:flex; gap:0.5rem; align-items:center; margin: 0.25rem 0rem;">
              <a href="https://www.quantinuum.com/privacy-statement" target="_blank">Privacy Statement</a>
              <div role="separator">/</div>
              <a href="https://www.quantinuum.com/cookie-notice" target="_blank">Cookie Notice</a>
              <div role="separator">/</div>
              <a href="https://www.quantinuum.com/terms-conditions" target="_blank">Terms and Conditions</a>
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Protocols for derivatives</a><ul>
<li><a class="reference internal" href="#hadamardtestderivative">HadamardTestDerivative</a></li>
<li><a class="reference internal" href="#hadamardtestderivativeoverlap">HadamardTestDerivativeOverlap</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/jquery.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script>
    </body>
</html>